{% extends "base.html" %}
{% block content %}

<h1 style="margin-bottom:16px;">上傳訓練截圖</h1>

<!-- =========================
     上傳進度 Overlay
     ========================= -->
<div id="upload-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;">
  <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
              width:min(560px, 92vw); background:#fff; border-radius:14px;
              padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <div style="font-weight:700; margin-bottom:10px;">上傳中…</div>
    <div id="upload-status" style="font-size:13px; color:#444; margin-bottom:10px;">準備上傳…</div>
    <div style="height:10px; background:#eee; border-radius:999px; overflow:hidden;">
      <div id="upload-bar" style="height:100%; width:0%; background:#1a73e8;"></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:13px; color:#444;">
      <div id="upload-count">0/0</div>
      <div id="upload-pct">0%</div>
    </div>
  </div>
</div>

<!-- =========================
     上傳表單
     ========================= -->
<form id="upload-form" method="post" enctype="multipart/form-data" style="margin-bottom:24px;">
  {% csrf_token %}
  <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
    <input type="file" name="images" id="id_images" accept="image/*" multiple>
    <button type="submit" id="upload-btn">上傳圖片</button>
  </div>
</form>

{% if results %}
<form method="post" action="{% url 'uma:bulk_update_results' %}" id="bulk-form">
  {% csrf_token %}

  {% for r in results %}
  <input type="hidden" name="result_ids" value="{{ r.id }}">

  <div style="border:1px solid #ddd; border-radius:10px; padding:16px; margin-bottom:18px;">

    <!-- 頭像 + 分數 -->
    <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
      {% if r.portrait_crop %}
        <img src="{{ r.portrait_crop.url }}" style="width:88px; height:88px; object-fit:cover; border-radius:12px;">
      {% elif r.portrait %}
        <img src="{{ r.portrait.url }}" style="width:88px; height:88px; object-fit:cover; border-radius:12px;">
      {% else %}
        <div style="width:88px; height:88px; border:1px solid #ddd; border-radius:12px;
                    display:flex; align-items:center; justify-content:center; color:#777;">
          No Image
        </div>
      {% endif %}

      <div>
        <div style="font-weight:600; margin-bottom:6px;">分數</div>
        <input type="number" name="score_{{ r.id }}" value="{{ r.score }}" min="0">
      </div>
    </div>

    <hr>

    <!-- 五維能力 -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; max-width:700px;">
      <div>速度 <input type="number" name="speed_{{ r.id }}" value="{{ r.speed }}"></div>
      <div>耐力 <input type="number" name="stamina_{{ r.id }}" value="{{ r.stamina }}"></div>
      <div>力量 <input type="number" name="power_{{ r.id }}" value="{{ r.power }}"></div>
      <div>根性 <input type="number" name="guts_{{ r.id }}" value="{{ r.guts }}"></div>
      <div>智力 <input type="number" name="intelligence_{{ r.id }}" value="{{ r.intelligence }}"></div>
    </div>

    <hr>

    <!-- 資質 -->
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; max-width:900px;">

      <div>
        <div>場地</div>
        <input type="hidden" id="terrain_{{ r.id }}" name="terrain_{{ r.id }}" value="{{ r.terrain }}">
        <div class="choice-group" data-field="terrain_{{ r.id }}">
          <button type="button" class="choice-btn" data-value="草地">草地</button>
          <button type="button" class="choice-btn" data-value="沙地">沙地</button>
          <button type="button" class="clear-btn">清除</button>
        </div>
      </div>

      <div>
        <div>距離</div>
        <input type="hidden" id="distance_{{ r.id }}" name="distance_{{ r.id }}" value="{{ r.distance }}">
        <div class="choice-group" data-field="distance_{{ r.id }}">
          <button type="button" class="choice-btn" data-value="短距離">短距離</button>
          <button type="button" class="choice-btn" data-value="一哩">一哩</button>
          <button type="button" class="choice-btn" data-value="中距離">中距離</button>
          <button type="button" class="choice-btn" data-value="長距離">長距離</button>
          <button type="button" class="clear-btn">清除</button>
        </div>
      </div>

      <div>
        <div>腳質</div>
        <input type="hidden" id="strategy_{{ r.id }}" name="strategy_{{ r.id }}" value="{{ r.strategy }}">
        <div class="choice-group" data-field="strategy_{{ r.id }}">
          <button type="button" class="choice-btn" data-value="領頭">領頭</button>
          <button type="button" class="choice-btn" data-value="前">前列</button>
          <button type="button" class="choice-btn" data-value="中">居中</button>
          <button type="button" class="choice-btn" data-value="後">後追</button>
          <button type="button" class="clear-btn">清除</button>
        </div>
      </div>

    </div>
  </div>
  {% endfor %}

  <button type="submit" style="padding:10px 16px;">儲存全部</button>
</form>

<style>
  .choice-group { display:flex; gap:8px; flex-wrap:wrap; }
  .choice-btn, .clear-btn {
    padding:6px 10px; border:1px solid #aaa; background:#fff;
    border-radius:6px; cursor:pointer;
  }
  .choice-btn.active { border-color:#1a73e8; color:#1a73e8; font-weight:600; }
</style>

<script>
(function(){
  /* ===== 資質按鈕 ===== */
  function sync(group){
    const hidden = document.getElementById(group.dataset.field);
    const val = (hidden?.value || "").trim();
    group.querySelectorAll(".choice-btn").forEach(b=>{
      b.classList.toggle("active", b.dataset.value === val);
    });
  }
  document.querySelectorAll(".choice-group").forEach(sync);

  document.addEventListener("click", e=>{
    const group = e.target.closest(".choice-group");
    if(!group) return;
    const hidden = document.getElementById(group.dataset.field);
    if(!hidden) return;

    if(e.target.classList.contains("choice-btn")){
      hidden.value = e.target.dataset.value;
      sync(group);
    }
    if(e.target.classList.contains("clear-btn")){
      hidden.value = "";
      sync(group);
    }
  });

  /* ===== 上傳進度條 ===== */
  const overlay = document.getElementById("upload-overlay");
  const bar = document.getElementById("upload-bar");
  const pct = document.getElementById("upload-pct");
  const countEl = document.getElementById("upload-count");
  const uploadForm = document.getElementById("upload-form");
  const uploadBtn = document.getElementById("upload-btn");

  uploadForm.addEventListener("submit", function(e){
    e.preventDefault();

    const files = document.getElementById("id_images").files;
    if(!files.length){ alert("請先選擇圖片"); return; }

    overlay.style.display = "block";
    uploadBtn.disabled = true;
    bar.style.width = "0%";
    pct.textContent = "0%";
    countEl.textContent = `0/${files.length}`;

    const fd = new FormData(uploadForm);
    const xhr = new XMLHttpRequest();
    xhr.open("POST", window.location.href, true);

    xhr.upload.onprogress = ev=>{
      if(!ev.lengthComputable) return;
      const p = Math.round(ev.loaded / ev.total * 100);
      bar.style.width = p + "%";
      pct.textContent = p + "%";
    };

    xhr.onload = ()=>{
      uploadBtn.disabled = false;
      if(xhr.status >= 200 && xhr.status < 300){
        document.open(); document.write(xhr.responseText); document.close();
      }else{
        overlay.style.display = "none";
        alert("上傳失敗");
      }
    };

    xhr.onerror = ()=>{
      uploadBtn.disabled = false;
      overlay.style.display = "none";
      alert("上傳失敗");
    };

    xhr.send(fd);
  });
})();
</script>

{% endif %}
{% endblock %}
